name: Build and Deploy ROFL Agent

on:
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to testnet after build'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - 'packages/rofl-poc/**'

env:
  DOCKER_IMAGE: docker.io/filipeai/rofl-eliza:latest

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push Eliza image
        uses: docker/build-push-action@v5
        with:
          context: packages/rofl-poc/rofl-eliza
          platforms: linux/amd64
          push: true
          tags: ${{ env.DOCKER_IMAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-rofl-bundle:
    needs: build-and-push-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build ROFL bundle
        working-directory: packages/rofl-poc
        run: |
          docker run --platform linux/amd64 \
            --volume $(pwd):/src \
            ghcr.io/oasisprotocol/rofl-dev:main \
            oasis rofl build
      
      - name: Upload ROFL bundle
        uses: actions/upload-artifact@v4
        with:
          name: rofl-bundle
          path: packages/rofl-poc/*.orc
          retention-days: 30

  deploy:
    needs: build-rofl-bundle
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Download ROFL bundle
        uses: actions/download-artifact@v4
        with:
          name: rofl-bundle
          path: packages/rofl-poc
      
      - name: Setup Oasis wallet
        working-directory: packages/rofl-poc
        run: |
          # Install Oasis CLI
          curl -fsSL https://github.com/oasisprotocol/cli/releases/download/v0.17.0/oasis_cli_0.17.0_linux_amd64.tar.gz | tar -xz
          sudo mv oasis_cli_0.17.0_linux_amd64/oasis /usr/local/bin/
          
          # Setup wallet
          mkdir -p ~/.config/oasis
          
          # Import wallet using mnemonic (non-interactive)
          # We sanitize the secret to remove newlines/spaces
          CLEAN_SECRET=$(echo "${{ secrets.OASIS_WALLET }}" | tr -d '\n' | xargs)
          printf "${{ secrets.OASIS_WALLET_PASSPHRASE }}\n${{ secrets.OASIS_WALLET_PASSPHRASE }}\n" | oasis wallet import agentcred_deployer --secret "$CLEAN_SECRET" --algorithm ed25519-adr8 --yes
      
      - name: Deploy to testnet
        working-directory: packages/rofl-poc
        env:
          OASIS_WALLET_PASSPHRASE: ${{ secrets.OASIS_WALLET_PASSPHRASE }}
        run: |
          printf "${{ secrets.OASIS_WALLET_PASSPHRASE }}\n" | docker run --platform linux/amd64 \
            --volume $(pwd):/src \
            --volume $HOME/.config/oasis:/root/.config/oasis \
            -i \
            ghcr.io/oasisprotocol/rofl-dev:main \
            oasis rofl deploy --account agentcred_deployer --yes
